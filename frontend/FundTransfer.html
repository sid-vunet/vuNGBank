<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VuBank - Fund Transfer</title>
    
    <!-- Elastic RUM Agent -->
    <script src="./elastic-apm-rum.js" crossorigin></script>
    <script>
        // Initialize Elastic RUM with MAXIMUM automatic data capture
        window.elasticApm = elasticApm.init({
            // === CORE CONFIGURATION ===
            serviceName: 'vubank-frontend',
            serverUrl: 'http://91.203.133.240:30200',
            serviceVersion: '1.0.0',
            environment: 'production',
            
            // === DISTRIBUTED TRACING (Temporarily disabled to eliminate CORS errors) ===
            distributedTracing: false,
            distributedTracingOrigins: [
                // Kong Gateway (main API endpoint for browser)
                'http://localhost:8086',
                
                // Local development endpoints (if directly accessible)
                'http://localhost:8000', 'http://localhost:8001', 'http://localhost:8002', 
                'http://localhost:8003', 'http://localhost:8004', 'http://localhost:8005',
                'http://localhost:5004',
                
                // APM server endpoints
                'http://91.203.133.240:30200',
                'https://91.203.133.240:30200',
                
                // Current frontend host
                window.location.origin
            ],
            
            // === AUTOMATIC INSTRUMENTATION (Enable Everything) ===
            disableInstrumentations: [], // Empty = enable all automatic capture
            
            // === HTTP INSTRUMENTATION ===
            instrumentFetch: true,          // Capture fetch requests
            instrumentXMLHttpRequest: true, // Capture XHR requests
            captureHeaders: true,          // Capture HTTP headers
            captureBody: 'all',           // Capture request/response bodies
            
            // === PAGE LOAD INSTRUMENTATION ===
            capturePageLoad: true,         // Capture page load metrics
            capturePageLoadSpans: true,    // Detailed page load spans
            pageLoadTransactionName: 'fund-transfer-page-load',
            pageLoadSpanId: true,         // Include span IDs
            
            // === USER INTERACTION INSTRUMENTATION ===
            captureUserInteractions: true, // Auto-capture clicks, form submissions
            userInteractionTimeout: 5000,  // Keep interactions active for 5s
            
            // === NAVIGATION INSTRUMENTATION ===
            captureNavigation: true,       // Single-page app navigation
            
            // === ERROR INSTRUMENTATION ===
            captureErrors: true,           // Automatic error capture
            errorThrottleLimit: 200,       // Allow many error reports
            errorThrottleInterval: 30000,  // Reset error throttle every 30s
            captureUnhandledRejections: true, // Promise rejections
            
            // === PERFORMANCE MONITORING ===
            // Transaction sampling
            transactionSampleRate: 1.0,    // Capture 100% of transactions
            
            // Span sampling  
            spanSampleRate: 1.0,          // Capture 100% of spans
            
            // Transaction timeout
            transactionTimeout: 30000,     // 30 second timeout for long operations
            
            // === RESOURCE MONITORING ===
            captureResourceTimings: true,  // CSS, JS, image load times
            
            // === BREAKDOWN METRICS ===
            breakdownMetrics: true,        // Detailed performance breakdowns
            
            // === SESSION TRACKING ===
            session: true,                 // Enable session tracking
            sessionTimeout: 30 * 60 * 1000, // 30 minute sessions
            
            // === SPAN CONFIGURATION ===
            spanStackTraceMinDuration: 0,  // Capture stack traces for all spans
            spanCompressionEnabled: false, // Disable compression for full detail
            
            // === LOGGING ===
            logLevel: 'trace',            // Maximum logging detail
            sendCredentials: false,        // Security consideration
            
            // === METADATA CAPTURE ===
            captureSpanStackTraces: true, // Stack traces in spans
            sourcemapsEnabled: true,      // Source map support
            
            // === CONTEXT PROPAGATION ===
            propagateTracestate: true,    // W3C trace context
            
            // === CUSTOM CONTEXT (Automatic) ===
            context: {
                user: {
                    id: 'auto-detected',
                    username: 'auto-detected', 
                    email: 'auto-detected'
                },
                custom: {
                    application: 'vubank-frontend',
                    version: '1.0.0',
                    page: 'fund-transfer-page'
                }
            },
            
            // === LONG TASK MONITORING ===
            longTask: {
                threshold: 50 // Capture tasks longer than 50ms
            },
            
            // === CENTRAL CONFIGURATION ===
            centralConfig: true,          // Allow server-side config updates
            
            // === ADVANCED PERFORMANCE ===
            memoryLimit: 10 * 1024 * 1024, // 10MB memory limit
            queueLimit: 1000,             // Large event queue
            flushInterval: 500,           // Flush every 500ms
            
            // === EXPERIMENTAL FEATURES ===
            experimental: {
                asyncStack: true,         // Async stack traces
            },
            
            // === API REQUEST DETAILS ===
            apiRequestTime: true,         // Capture API timings
            apiRequestSize: true,         // Capture request sizes
            
            // === BROWSER METRICS ===
            browserHistory: true,         // Browser history changes
            
            // Enable active monitoring
            active: true
        });
        
        // Enhanced authentication validation function for fund transfer page
        async function validateAuthenticationOnLoad() {
            const token = localStorage.getItem('vubank_token');
            const userStr = localStorage.getItem('vubank_user');
            
            // Basic checks first
            if (!token || !userStr) {
                console.warn('No authentication token or user data found, redirecting to login');
                window.location.href = 'login.html';
                return false;
            }
            
            try {
                // Parse and validate user data
                const userData = JSON.parse(userStr);
                if (!userData.id || !userData.username) {
                    throw new Error('Invalid user data structure');
                }
                
                return true;
                
            } catch (error) {
                console.error('Authentication validation failed:', error);
                
                // Clear invalid data and redirect
                localStorage.removeItem('vubank_token');
                localStorage.removeItem('vubank_user');
                window.location.href = 'login.html';
                return false;
            }
        }
        
        // Immediately validate authentication on page load
        validateAuthenticationOnLoad().then(isValid => {
            if (!isValid) {
                return; // Already redirected to login
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f9fafb;
            min-height: 100vh;
        }

        .transfer-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* User info and dropdown styles */
        .header-user {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 24px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .user-avatar:hover {
            background: #2563eb;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            position: relative;
            cursor: pointer;
        }

        .user-info:hover .user-name {
            color: #3b82f6;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: #1f2937;
        }

        .user-details {
            color: #6b7280;
            font-size: 12px;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 120px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-5px);
            transition: all 0.2s ease-in-out;
            margin-top: 8px;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #374151;
            text-decoration: none;
            font-size: 14px;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #f3f4f6;
            color: #ef4444;
        }

        .dropdown-item svg {
            margin-right: 8px;
            font-size: 16px;
        }

        /* Modal styles for logout confirmation */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
        }

        .modal-message {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .modal-btn-primary {
            background: #ef4444;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #dc2626;
        }

        .modal-btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-btn-secondary:hover {
            background: #e5e7eb;
        }

        .transfer-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px;
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 32px;
        }

        .progress-steps {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .step-circle.active {
            background: #3b82f6;
            color: white;
        }

        .step-circle.completed {
            background: #10b981;
            color: white;
        }

        .step-circle.pending {
            background: #f3f4f6;
            color: #9ca3af;
            border: 2px solid #e5e7eb;
        }

        .step-label {
            font-size: 12px;
            color: #6b7280;
            white-space: nowrap;
        }

        .step-connector {
            width: 40px;
            height: 2px;
            background: #e5e7eb;
        }

        .step-connector.completed {
            background: #10b981;
        }

        .transfer-card {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .transfer-main-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .payee-search-section {
            text-align: center;
        }

        .payee-search-input {
            font-size: 18px;
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 32px;
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-add-new-payee {
            background: #f3f4f6;
            border: 2px solid #d1d5db;
            color: #374151;
            padding: 12px 24px;
            display: flex;
            align-items: center;
        }

        .btn-add-new-payee:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }

        .btn-proceed {
            padding: 12px 32px;
            font-weight: 600;
        }

        .btn-proceed:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .payee-dropdown {
            position: relative;
        }

        .payee-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .payee-suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f3f4f6;
        }

        .suggestion-item:hover {
            background: #f9fafb;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .add-payee-item {
            background: #f0f9ff;
            color: #1e40af;
            font-weight: 600;
        }

        .add-payee-suggestion {
            border-top: 1px solid #e5e7eb;
            background: #eff6ff;
        }

        .add-payee-suggestion:hover {
            background: #dbeafe;
        }

        .add-payee-item:hover {
            background: #dbeafe;
        }

        .btn-transfer-now {
            background: #10b981;
            color: white;
            border: none;
        }

        .btn-transfer-now:hover {
            background: #059669;
        }

        .btn-transfer-now:disabled {
            background: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
        }

        /* Add Payee Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .modal .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transform: translateY(-50px);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .modal-close:hover {
            color: #374151;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
        }

        .bank-details {
            margin-top: 8px;
            padding: 12px;
            background: #f0fdf4;
            border: 1px solid #dcfce7;
            border-radius: 6px;
        }

        .bank-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .bank-info span:first-child {
            font-weight: 600;
            color: #059669;
        }

        .bank-info span:last-child {
            font-size: 14px;
            color: #047857;
        }

        .validation-message {
            margin-top: 4px;
            font-size: 12px;
            min-height: 16px;
        }

        .validation-message.success {
            color: #059669;
        }

        .validation-message.error {
            color: #dc2626;
        }

        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 0.8s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .account-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .account-option {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .account-option:hover {
            border-color: #d1d5db;
            background: #f9fafb;
        }

        .account-option.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        /* Distinctive colors for account types */
        .account-option.savings-account {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .account-option.savings-account:hover {
            background: #dcfce7;
            border-color: #86efac;
        }

        .account-option.savings-account.selected {
            background: #ecfdf5;
            border-color: #10b981;
        }

        .account-option.checking-account {
            background: #eff6ff;
            border-color: #bfdbfe;
        }

        .account-option.checking-account:hover {
            background: #dbeafe;
            border-color: #93c5fd;
        }

        .account-option.checking-account.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .account-type {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .account-balance {
            font-size: 14px;
            color: #6b7280;
        }

        .balance-amount {
            font-weight: 600;
            color: #10b981;
        }

        .payment-modes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .payment-mode {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .payment-mode:hover {
            border-color: #d1d5db;
            background: #f9fafb;
        }

        .payment-mode.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .payment-mode-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .payment-mode-limit {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .payment-mode-time {
            font-size: 12px;
            color: #059669;
            font-weight: 500;
        }

        .amount-input-container {
            position: relative;
        }

        .amount-input {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            padding: 20px;
            letter-spacing: 1px;
        }

        .currency-symbol {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            font-weight: 600;
            color: #6b7280;
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            margin-top: 32px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .transfer-step {
            display: none;
        }

        .transfer-step.active {
            display: block;
        }

        .confirmation-details {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #6b7280;
            font-size: 14px;
        }

        .detail-value {
            font-weight: 600;
            color: #374151;
        }

        .pin-input-container {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 32px 0;
        }

        .pin-digit {
            width: 60px;
            height: 60px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            background: white;
        }

        .pin-digit:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .transaction-success {
            text-align: center;
            padding: 40px 20px;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .success-message {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .transaction-id {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 32px;
        }

        .receipt-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .transfer-container {
                padding: 16px;
            }

            .transfer-card {
                padding: 24px 20px;
            }

            .account-selector {
                grid-template-columns: 1fr;
            }

            .payment-modes {
                grid-template-columns: 1fr;
            }

            .progress-steps {
                gap: 8px;
            }

            .step-connector {
                width: 20px;
            }

            .step-label {
                display: none;
            }

            .receipt-actions {
                flex-direction: column;
            }

            .pin-input-container {
                gap: 8px;
            }

            .pin-digit {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="transfer-header">
        <div class="header-content">
            <div class="header-left">
                <button class="back-btn" onclick="goBack()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <h1 class="page-title">Fund Transfer</h1>
            </div>
            <div class="header-right">
                <div class="header-user">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info" id="userInfo">
                        <div class="user-name" id="userName">User</div>
                        <div class="user-details" id="userDetails">ID: - | Roles: -</div>
                        <div class="user-dropdown" id="userDropdown">
                            <button class="dropdown-item" id="logoutBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 17L21 12L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="transfer-container">
        <!-- Progress Indicator -->
        <div class="progress-indicator">
            <div class="progress-steps">
                <div class="progress-step">
                    <div class="step-circle active" id="step1Circle">1</div>
                    <div class="step-label">Select Payee</div>
                </div>
                <div class="step-connector" id="connector1"></div>
                <div class="progress-step">
                    <div class="step-circle pending" id="step2Circle">2</div>
                    <div class="step-label">Payment Details</div>
                </div>
                <div class="step-connector" id="connector2"></div>
                <div class="progress-step">
                    <div class="step-circle pending" id="step3Circle">3</div>
                    <div class="step-label">Confirmation</div>
                </div>
                <div class="step-connector" id="connector3"></div>
                <div class="progress-step">
                    <div class="step-circle pending" id="step4Circle">4</div>
                    <div class="step-label">Security</div>
                </div>
                <div class="step-connector" id="connector4"></div>
                <div class="progress-step">
                    <div class="step-circle pending" id="step5Circle">5</div>
                    <div class="step-label">Complete</div>
                </div>
            </div>
        </div>

        <!-- Main Fund Transfer Page -->
        <div class="transfer-step active" id="step1">
            <div class="transfer-card">
                <h2 style="margin-bottom: 32px; color: #1f2937; text-align: center;">Fund Transfer</h2>
                
                <div class="transfer-main-content">
                    <div class="payee-search-section">
                        <div class="form-group">
                            <label class="form-label" for="payeeSearch">Search for a Payee</label>
                            <div class="payee-dropdown">
                                <input 
                                    type="text" 
                                    id="payeeSearch" 
                                    class="form-input payee-search-input" 
                                    placeholder="Start typing payee name..."
                                    autocomplete="off"
                                >
                                <div class="payee-suggestions" id="payeeSuggestions">
                                    <!-- Dynamic payee suggestions will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="button" class="btn btn-secondary btn-add-new-payee" onclick="window.fundTransferManager.showAddPayeeForm()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <line x1="12" y1="8" x2="12" y2="16" stroke="currentColor" stroke-width="2"/>
                                    <line x1="8" y1="12" x2="16" y2="12" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Add New Payee
                            </button>
                            
                            <button type="button" class="btn btn-primary btn-proceed" id="proceedBtn" onclick="window.fundTransferManager.proceedToPayment()" disabled>
                                Proceed to Payment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Payment Details -->
        <div class="transfer-step" id="step2">
            <div class="transfer-card">
                <h2 style="margin-bottom: 24px; color: #1f2937;">Payment Details</h2>
                
                <div class="form-group">
                    <label class="form-label">Transfer From</label>
                    <div class="account-selector">
                        <div class="account-option savings-account" id="savingsAccount" onclick="selectAccount('savings')">
                            <div class="account-type">Savings Account</div>
                            <div class="account-balance">Balance: <span class="balance-amount" id="savingsBalance">₹0.00</span></div>
                        </div>
                        <div class="account-option checking-account" id="checkingAccount" onclick="selectAccount('checking')">
                            <div class="account-type">Checking Account</div>
                            <div class="account-balance">Balance: <span class="balance-amount" id="checkingBalance">₹0.00</span></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Payment Mode</label>
                    <div class="payment-modes">
                        <div class="payment-mode" id="upiMode" onclick="selectPaymentMode('UPI')">
                            <div class="payment-mode-name">UPI</div>
                            <div class="payment-mode-limit">Up to ₹1,00,000</div>
                            <div class="payment-mode-time">Instant</div>
                        </div>
                        <div class="payment-mode" id="impsMode" onclick="selectPaymentMode('IMPS')">
                            <div class="payment-mode-name">IMPS</div>
                            <div class="payment-mode-limit">Up to ₹5,00,000</div>
                            <div class="payment-mode-time">Instant</div>
                        </div>
                        <div class="payment-mode" id="neftMode" onclick="selectPaymentMode('NEFT')">
                            <div class="payment-mode-name">NEFT</div>
                            <div class="payment-mode-limit">Up to ₹50,00,000</div>
                            <div class="payment-mode-time">2-3 hours</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="transferAmount">Transfer Amount</label>
                    <div class="amount-input-container">
                        <span class="currency-symbol">₹</span>
                        <input 
                            type="number" 
                            id="transferAmount" 
                            class="form-input amount-input" 
                            placeholder="0.00"
                            step="0.01"
                            min="1"
                        >
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="transferNote">Transfer Note (Optional)</label>
                    <input 
                        type="text" 
                        id="transferNote" 
                        class="form-input" 
                        placeholder="Enter purpose of transfer..."
                        maxlength="100"
                    >
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(1)">Back</button>
                    <button class="btn btn-primary" id="continueToStep3" onclick="goToStep(3)" disabled>
                        Continue
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Confirmation -->
        <div class="transfer-step" id="step3">
            <div class="transfer-card">
                <h2 style="margin-bottom: 24px; color: #1f2937;">Review Transfer Details</h2>
                
                <div class="confirmation-details" id="confirmationDetails">
                    <!-- Dynamic confirmation details will be populated here -->
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(2)">Back</button>
                    <button class="btn btn-primary" onclick="goToStep(4)">
                        Confirm & Proceed
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 4: Security PIN -->
        <div class="transfer-step" id="step4">
            <div class="transfer-card">
                <h2 style="margin-bottom: 24px; color: #1f2937; text-align: center;">Enter Transaction PIN</h2>
                
                <p style="text-align: center; color: #6b7280; margin-bottom: 32px;">
                    Please enter your 6-digit transaction PIN to authorize this transfer
                </p>

                <div class="pin-input-container" id="pinContainer">
                    <input type="password" class="pin-digit" maxlength="1" id="pin1">
                    <input type="password" class="pin-digit" maxlength="1" id="pin2">
                    <input type="password" class="pin-digit" maxlength="1" id="pin3">
                    <input type="password" class="pin-digit" maxlength="1" id="pin4">
                    <input type="password" class="pin-digit" maxlength="1" id="pin5">
                    <input type="password" class="pin-digit" maxlength="1" id="pin6">
                </div>

                <div id="pinError" class="error-message" style="display: none;">
                    Invalid PIN. Please try again.
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(3)">Back</button>
                    <button class="btn btn-primary" id="processTransfer" onclick="processTransfer()" disabled>
                        Process Transfer
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 5: Success -->
        <div class="transfer-step" id="step5">
            <div class="transfer-card">
                <div class="transaction-success">
                    <div class="success-icon">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 6L9 17L4 12" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <h2 class="success-message">Transfer Successful!</h2>
                    <p class="transaction-id">Transaction ID: <span id="transactionId">TXN123456789</span></p>
                    
                    <div class="confirmation-details" id="finalTransactionDetails">
                        <!-- Final transaction details will be populated here -->
                    </div>

                    <div class="receipt-actions">
                        <button class="btn btn-secondary" onclick="downloadReceipt()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                                <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <polyline points="7,10 12,15 17,10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Download Receipt
                        </button>
                        <button class="btn btn-primary" onclick="makeAnotherTransfer()">
                            Make Another Transfer
                        </button>
                        <button class="btn btn-secondary" onclick="goToDashboard()">
                            Back to Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Processing your transfer...</p>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="modal-overlay" id="logoutModal">
        <div class="modal-content">
            <h3 class="modal-title">Confirm Logout</h3>
            <p class="modal-message">Are you sure you want to logout? You will lose your current transfer progress and be redirected to the login page.</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancelLogout">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="confirmLogout">Logout</button>
            </div>
        </div>
    </div>

    <!-- Add Payee Modal -->
    <div class="modal" id="addPayeeModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Add New Payee</h2>
                <button class="modal-close" onclick="hideAddPayeeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addPayeeForm" onsubmit="handleAddPayee(event)">
                    <div class="form-group">
                        <label class="form-label" for="payeeName">Payee Name</label>
                        <input type="text" id="payeeName" class="form-input" required 
                               placeholder="Enter payee name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="payeeAccountNumber">Account Number</label>
                        <input type="text" id="payeeAccountNumber" class="form-input" required 
                               placeholder="Enter account number" pattern="[0-9]+" minlength="8" maxlength="20">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="payeeIfscCode">IFSC Code</label>
                        <input type="text" id="payeeIfscCode" class="form-input" required 
                               placeholder="Enter IFSC code (e.g., SBIN0000001)" 
                               pattern="[A-Z]{4}0[A-Z0-9]{6}" maxlength="11" style="text-transform: uppercase">
                        <div id="ifscValidationMessage" class="validation-message"></div>
                        <div id="bankDetails" class="bank-details" style="display: none;">
                            <div class="bank-info">
                                <span id="bankName"></span>
                                <span id="branchName"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="payeeAccountType">Account Type</label>
                        <select id="payeeAccountType" class="form-input" required>
                            <option value="">Select account type</option>
                            <option value="Savings">Savings</option>
                            <option value="Current">Current</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideAddPayeeModal()">Cancel</button>
                <button type="submit" form="addPayeeForm" class="btn btn-primary" id="addPayeeSubmit">
                    Add Payee
                </button>
                <button type="button" class="btn btn-transfer-now" id="transferNowBtn" onclick="window.fundTransferManager.handleTransferNow()" style="display: none;">
                    Proceed to Pay
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global functions for modal interaction
        function hideAddPayeeModal() {
            if (window.fundTransferManager) {
                window.fundTransferManager.hideAddPayeeModal();
            }
        }

        function handleAddPayee(event) {
            if (window.fundTransferManager) {
                window.fundTransferManager.handleAddPayee(event);
            }
        }

        function showAddPayeeForm(query = '') {
            if (window.fundTransferManager) {
                window.fundTransferManager.showAddPayeeForm(query);
            }
        }

        function handleTransferNow() {
            if (window.fundTransferManager) {
                window.fundTransferManager.handleTransferNow();
            }
        }

        class FundTransferManager {
            constructor() {
                this.currentStep = 1;
                this.selectedPayee = null;
                this.selectedAccount = null;
                this.selectedPaymentMode = null;
                this.transferAmount = 0;
                this.transferNote = '';
                this.userAccounts = [];
                this.user = null;
                this.payees = [];
                this.transactionId = null;
                
                this.initializeElements();
                this.initializeEventListeners();
                this.loadUserData();
                this.loadPayees();
            }

            initializeElements() {
                // User elements
                this.userAvatar = document.getElementById('userAvatar');
                this.userName = document.getElementById('userName');
                this.userDetails = document.getElementById('userDetails');
                this.userInfo = document.getElementById('userInfo');
                this.userDropdown = document.getElementById('userDropdown');
                this.logoutModal = document.getElementById('logoutModal');
                this.cancelLogout = document.getElementById('cancelLogout');
                this.confirmLogout = document.getElementById('confirmLogout');
                
                // Transfer form elements
                this.payeeSearch = document.getElementById('payeeSearch');
                this.payeeSuggestions = document.getElementById('payeeSuggestions');
                this.transferAmountInput = document.getElementById('transferAmount');
                this.transferNoteInput = document.getElementById('transferNote');
                this.checkingBalanceSpan = document.getElementById('checkingBalance');
                this.savingsBalanceSpan = document.getElementById('savingsBalance');
                this.confirmationDetails = document.getElementById('confirmationDetails');
                this.finalTransactionDetails = document.getElementById('finalTransactionDetails');
                this.transactionIdSpan = document.getElementById('transactionId');
                this.loadingOverlay = document.getElementById('loadingOverlay');
                this.pinError = document.getElementById('pinError');

                // PIN inputs
                this.pinInputs = [];
                for (let i = 1; i <= 6; i++) {
                    this.pinInputs.push(document.getElementById(`pin${i}`));
                }

                // Continue buttons
                this.continueToStep2 = document.getElementById('continueToStep2');
                this.continueToStep3 = document.getElementById('continueToStep3');
                this.processTransferBtn = document.getElementById('processTransfer');
            }

            initializeEventListeners() {
                // User dropdown functionality
                this.userAvatar.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleUserDropdown();
                });

                this.userInfo.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleUserDropdown();
                });

                // Logout functionality
                const logoutBtn = this.userDropdown.querySelector('#logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.showLogoutModal();
                    });
                }

                this.cancelLogout.addEventListener('click', () => this.hideLogoutModal());
                this.confirmLogout.addEventListener('click', () => this.handleLogout());

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.header-user')) {
                        this.hideUserDropdown();
                    }
                    if (!e.target.closest('.payee-dropdown')) {
                        this.hidePayeeSuggestions();
                    }
                });

                // Close modal when clicking overlay
                this.logoutModal.addEventListener('click', (e) => {
                    if (e.target === this.logoutModal) {
                        this.hideLogoutModal();
                    }
                });

                // Payee search
                this.payeeSearch.addEventListener('input', (e) => this.handlePayeeSearch(e.target.value));
                this.payeeSearch.addEventListener('focus', () => this.showPayeeSuggestions());

                // Amount input
                this.transferAmountInput.addEventListener('input', () => this.validateStep2());

                // PIN inputs
                this.pinInputs.forEach((input, index) => {
                    input.addEventListener('input', (e) => this.handlePinInput(e, index));
                    input.addEventListener('keydown', (e) => this.handlePinKeydown(e, index));
                });

                // Add payee modal form IFSC validation
                setTimeout(() => {
                    const ifscInput = document.getElementById('payeeIfscCode');
                    if (ifscInput) {
                        ifscInput.addEventListener('input', (e) => {
                            const ifscCode = e.target.value.toUpperCase();
                            e.target.value = ifscCode;
                            if (ifscCode.length === 11) {
                                this.validateIfscCode(ifscCode);
                            } else {
                                document.getElementById('ifscValidationMessage').textContent = '';
                                document.getElementById('bankDetails').style.display = 'none';
                            }
                        });
                    }
                }, 100);
            }

            async loadUserData() {
                const token = localStorage.getItem('vubank_token');
                const userStr = localStorage.getItem('vubank_user');

                if (!token || !userStr) {
                    window.location.href = 'login.html';
                    return;
                }

                try {
                    // Parse and update user information
                    this.user = JSON.parse(userStr);
                    this.updateUserInfo();

                    // Load account data from accounts service directly
                    const apiUrl = 'http://localhost:8086'; // Kong Gateway API URL
                    const response = await fetch(`${apiUrl}/internal/accounts`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                            'Origin': window.location.origin,
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-Api-Client': 'web-portal'
                        }
                    });

                    if (response.status === 401) {
                        // Token expired or invalid
                        window.location.href = 'login.html';
                        return;
                    }

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Raw API response:', data);
                        
                        // Transform account data to match expected structure
                        this.userAccounts = data.accounts.map(account => {
                            // Map "current" account type to "checking" for display
                            let accountType = account.accountType.toLowerCase();
                            if (accountType === 'current') {
                                accountType = 'checking';
                            }
                            
                            return {
                                id: account.id,
                                account_type: accountType,
                                balance: account.balance,
                                accountNumber: account.accountNumber,
                                accountName: account.accountName || account.accountType,
                                currency: account.currency || 'INR'
                            };
                        });
                        
                        console.log('Transformed account data:', this.userAccounts);
                        this.updateAccountBalances();
                    } else {
                        console.error('Failed to load account data:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            }

            updateUserInfo() {
                if (this.user) {
                    this.userAvatar.textContent = this.user.username.charAt(0).toUpperCase();
                    this.userName.textContent = this.user.username;
                    if (this.userDetails) {
                        this.userDetails.textContent = `ID: ${this.user.id} | Roles: ${this.user.roles?.join(', ') || 'N/A'}`;
                    }
                }
            }

            updateAccountBalances() {
                console.log('Updating account balances. Total accounts:', this.userAccounts.length);
                console.log('Account data:', this.userAccounts);
                
                const checkingAccount = this.userAccounts.find(acc => acc.account_type === 'checking');
                const savingsAccount = this.userAccounts.find(acc => acc.account_type === 'savings');

                console.log('Checking account found:', checkingAccount);
                console.log('Savings account found:', savingsAccount);

                if (checkingAccount) {
                    const balance = `₹${parseFloat(checkingAccount.balance).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
                    this.checkingBalanceSpan.textContent = balance;
                    console.log('Updated checking balance to:', balance);
                } else {
                    this.checkingBalanceSpan.textContent = '₹0.00';
                    console.log('No checking account found, set to ₹0.00');
                }

                if (savingsAccount) {
                    const balance = `₹${parseFloat(savingsAccount.balance).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
                    this.savingsBalanceSpan.textContent = balance;
                    console.log('Updated savings balance to:', balance);
                } else {
                    this.savingsBalanceSpan.textContent = '₹0.00';
                    console.log('No savings account found, set to ₹0.00');
                }
            }

            async loadPayees() {
                try {
                    // Load payees from API instead of hardcoded data
                    await this.loadPayeesFromAPI();
                } catch (error) {
                    console.error('Error loading payees:', error);
                    // Fallback to empty array if API fails
                    this.payees = [];
                }
            }

            async loadPayeesFromAPI() {
                try {
                    const token = localStorage.getItem('vubank_token');
                    if (!token) {
                        console.warn('No authentication token found');
                        this.payees = [];
                        return;
                    }

                    const response = await fetch('http://localhost:8086/api/payees', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const payeesData = await response.json();
                    
                    // Debug: Log the actual API response structure
                    console.log('Payees API Response:', payeesData);
                    if (payeesData.length > 0) {
                        console.log('First payee structure:', Object.keys(payeesData[0]));
                        console.log('First payee data:', payeesData[0]);
                    }
                    
                    // Transform API response to match frontend format with enhanced fields
                    this.payees = payeesData.map(payee => ({
                        id: payee.id,
                        name: payee.payeeName || payee.beneficiaryName || 'Unknown Name',
                        accountNumber: payee.accountNumber,
                        bankName: payee.bankName,
                        branchName: payee.branchName,
                        ifscCode: payee.ifscCode,
                        accountType: payee.accountType,
                        city: payee.city,
                        state: payee.state,
                        branchAddress: payee.branchAddress,
                        contactNumber: payee.contactNumber,
                        micrCode: payee.micrCode,
                        bankCode: payee.bankCode,
                        rtgsEnabled: payee.rtgsEnabled,
                        neftEnabled: payee.neftEnabled,
                        impsEnabled: payee.impsEnabled,
                        upiEnabled: payee.upiEnabled
                    }));

                    console.log(`Loaded ${this.payees.length} payees from API`);
                } catch (error) {
                    console.error('Error fetching payees from API:', error);
                    this.payees = [];
                    throw error;
                }
            }

            handlePayeeSearch(query) {
                if (query.length === 0) {
                    this.selectedPayee = null;
                    document.getElementById('proceedBtn').disabled = true;
                    this.hidePayeeSuggestions();
                    return;
                }

                const filteredPayees = this.payees.filter(payee =>
                    payee.name.toLowerCase().includes(query.toLowerCase()) ||
                    payee.accountNumber.includes(query)
                );

                this.displayPayeeSuggestions(filteredPayees, query);
            }

            displayPayeeSuggestions(payees, query) {
                this.payeeSuggestions.innerHTML = '';

                // Show existing payees
                payees.forEach(payee => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = `
                        <div style="font-weight: 600;">${payee.name}</div>
                        <div style="font-size: 12px; color: #6b7280;">${payee.accountNumber} - ${payee.bankName}</div>
                        <div style="font-size: 11px; color: #9ca3af;">${payee.branchName} (${payee.ifscCode})</div>
                    `;
                    item.onclick = () => this.selectPayee(payee);
                    this.payeeSuggestions.appendChild(item);
                });

                // Add "Add [name] as payee" option if no exact match and query is not empty
                if (query.trim() && !payees.some(p => p.name.toLowerCase() === query.toLowerCase().trim())) {
                    const addPayeeItem = document.createElement('div');
                    addPayeeItem.className = 'suggestion-item add-payee-suggestion';
                    addPayeeItem.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px; color: #3b82f6;">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <line x1="12" y1="8" x2="12" y2="16" stroke="currentColor" stroke-width="2"/>
                                <line x1="8" y1="12" x2="16" y2="12" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <div style="font-weight: 600; color: #3b82f6;">Add "${query.trim()}" as payee</div>
                        </div>
                    `;
                    addPayeeItem.onclick = () => this.showAddPayeeForm(query.trim());
                    this.payeeSuggestions.appendChild(addPayeeItem);
                }

                this.showPayeeSuggestions();
            }

            selectPayee(payee) {
                this.selectedPayee = payee;
                this.payeeSearch.value = payee.name;
                this.hidePayeeSuggestions();
                document.getElementById('proceedBtn').disabled = false;
            }

            showPayeeSuggestions() {
                this.payeeSuggestions.classList.add('show');
            }

            hidePayeeSuggestions() {
                this.payeeSuggestions.classList.remove('show');
            }

            toggleUserDropdown() {
                this.userDropdown.classList.toggle('show');
            }

            hideUserDropdown() {
                this.userDropdown.classList.remove('show');
            }

            showLogoutModal() {
                this.hideUserDropdown();
                this.logoutModal.classList.add('show');
            }

            hideLogoutModal() {
                this.logoutModal.classList.remove('show');
            }

            async handleLogout() {
                try {
                    const token = localStorage.getItem('vubank_token');
                    const user = JSON.parse(localStorage.getItem('vubank_user') || '{}');
                    
                    if (token && user?.id) {
                        try {
                            // Call backend logout API to terminate sessions
                            const apiUrl = 'http://localhost:8086'; // Kong Gateway API URL
                            
                            await fetch(`${apiUrl}/api/logout`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Api-Client': 'web-portal',
                                    'Authorization': `Bearer ${token}`,
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Origin': window.location.origin
                                },
                                body: JSON.stringify({
                                    user_id: user.id,
                                    terminate_all_sessions: true
                                })
                            });
                            
                        } catch (apiError) {
                            console.error('Logout API error:', apiError);
                        }
                    }
                    
                } catch (error) {
                    console.error('Error during logout:', error);
                } finally {
                    // Clear session/auth data regardless of API call result
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // Redirect to login page
                    window.location.href = '/login.html';
                }
            }

            showAddPayeeForm(query = '') {
                const modal = document.getElementById('addPayeeModal');
                const nameInput = document.getElementById('payeeName');
                
                // Reset button states when showing modal
                const submitBtn = document.getElementById('addPayeeSubmit');
                const transferBtn = document.getElementById('transferNowBtn');
                
                // Show Add Payee button, hide Transfer Now button
                submitBtn.style.display = 'inline-block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Payee';
                transferBtn.style.display = 'none';
                
                // Clear any previous state
                this.newlyAddedPayee = null;
                
                // Pre-fill name if query was provided
                if (query) {
                    nameInput.value = query;
                }
                
                modal.classList.add('show');
            }

            async validateIfscCode(ifscCode) {
                const validationMessage = document.getElementById('ifscValidationMessage');
                const bankDetails = document.getElementById('bankDetails');
                const bankName = document.getElementById('bankName');
                const branchName = document.getElementById('branchName');
                
                if (ifscCode.length !== 11) {
                    validationMessage.textContent = 'IFSC code must be 11 characters long';
                    validationMessage.className = 'validation-message error';
                    bankDetails.style.display = 'none';
                    return false;
                }

                // Show loading
                validationMessage.innerHTML = '<span class="loading-spinner"></span> Validating IFSC code...';
                validationMessage.className = 'validation-message';

                try {
                    const response = await fetch(`https://ifsc.razorpay.com/${ifscCode.toUpperCase()}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        bankName.textContent = data.BANK || 'Unknown Bank';
                        branchName.textContent = data.BRANCH || 'Unknown Branch';
                        bankDetails.style.display = 'block';
                        validationMessage.textContent = 'Valid IFSC code';
                        validationMessage.className = 'validation-message success';
                        return true;
                    } else {
                        throw new Error('Invalid IFSC code');
                    }
                } catch (error) {
                    validationMessage.textContent = 'Invalid IFSC code';
                    validationMessage.className = 'validation-message error';
                    bankDetails.style.display = 'none';
                    return false;
                }
            }

            async addPayeeToAPI(payeeData) {
                try {
                    const token = localStorage.getItem('vubank_token');
                    if (!token) {
                        throw new Error('No authentication token found');
                    }

                    const response = await fetch('http://localhost:8086/api/payees', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payeeData)
                    });

                    if (!response.ok) {
                        let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                        try {
                            const errorData = await response.json();
                            if (errorData.message) {
                                errorMessage = errorData.message;
                            } else if (errorData.errors) {
                                // Handle validation errors
                                errorMessage = Object.values(errorData.errors).flat().join(', ');
                            } else if (errorData.title) {
                                errorMessage = errorData.title;
                            }
                            console.error('Detailed API Error:', errorData);
                        } catch (parseError) {
                            console.error('Failed to parse error response:', parseError);
                        }
                        throw new Error(errorMessage);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Error adding payee:', error);
                    throw error;
                }
            }

            async handleAddPayee(event) {
                event.preventDefault();
                
                const submitBtn = document.getElementById('addPayeeSubmit');
                const transferBtn = document.getElementById('transferNowBtn');
                const originalText = submitBtn.textContent;
                
                try {
                    // Disable button and show loading
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="loading-spinner"></span> Adding...';
                    
                    const payeeName = document.getElementById('payeeName').value;
                    const accountNumber = document.getElementById('payeeAccountNumber').value;
                    const ifscCode = document.getElementById('payeeIfscCode').value.toUpperCase();
                    const accountType = document.getElementById('payeeAccountType').value;
                    
                    // Validate IFSC code first
                    const isValidIfsc = await this.validateIfscCode(ifscCode);
                    if (!isValidIfsc) {
                        throw new Error('Please enter a valid IFSC code');
                    }
                    
                    const payeeData = {
                        payeeName: payeeName,
                        beneficiaryName: payeeName,
                        accountNumber,
                        ifscCode,
                        accountType
                    };
                    
                    // Add payee via API
                    const newPayee = await this.addPayeeToAPI(payeeData);
                    
                    // Add to local payees array with enhanced fields
                    this.payees.push({
                        id: newPayee.id,
                        name: newPayee.payeeName,
                        accountNumber: newPayee.accountNumber,
                        bankName: newPayee.bankName,
                        branchName: newPayee.branchName,
                        ifscCode: newPayee.ifscCode,
                        accountType: newPayee.accountType,
                        city: newPayee.city,
                        state: newPayee.state,
                        branchAddress: newPayee.branchAddress,
                        contactNumber: newPayee.contactNumber,
                        micrCode: newPayee.micrCode,
                        bankCode: newPayee.bankCode,
                        rtgsEnabled: newPayee.rtgsEnabled,
                        neftEnabled: newPayee.neftEnabled,
                        impsEnabled: newPayee.impsEnabled,
                        upiEnabled: newPayee.upiEnabled
                    });
                    
                    // Store the newly added payee for "Proceed to Pay" functionality
                    this.newlyAddedPayee = this.payees[this.payees.length - 1];
                    
                    // Hide the Add Payee button and show Proceed to Pay button
                    submitBtn.style.display = 'none';
                    transferBtn.style.display = 'inline-block';
                    transferBtn.style.background = '#10b981';
                    transferBtn.textContent = 'Proceed to Pay';
                    
                    // Show success message
                    this.showSuccessMessage(`Payee "${payeeName}" added successfully!`);
                    
                } catch (error) {
                    console.error('Error adding payee:', error);
                    alert(`Error adding payee: ${error.message}`);
                    // Reset button on error
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }

            handleTransferNow() {
                if (this.newlyAddedPayee) {
                    // Set the newly added payee as selected
                    this.selectedPayee = this.newlyAddedPayee;
                    
                    // Close the modal
                    this.hideAddPayeeModal();
                    
                    // Go to step 2 with the payee pre-selected
                    this.goToStep(2);
                    
                    // Update the payee display in step 2
                    this.updateStep2PayeeDisplay();
                }
            }

            updateStep2PayeeDisplay() {
                if (this.selectedPayee) {
                    const payeeDisplayElement = document.getElementById('selectedPayeeDisplay');
                    if (payeeDisplayElement) {
                        payeeDisplayElement.innerHTML = `
                            <div class="payee-info">
                                <div class="payee-name">${this.selectedPayee.name}</div>
                                <div class="payee-details">${this.selectedPayee.accountNumber} • ${this.selectedPayee.bankName}</div>
                            </div>
                        `;
                    }
                }
            }

            proceedToPayment() {
                if (this.selectedPayee) {
                    // Go to step 2 with the selected payee
                    this.goToStep(2);
                    this.updateStep2PayeeDisplay();
                } else {
                    alert('Please select a payee first');
                }
            }

            hideAddPayeeModal() {
                const modal = document.getElementById('addPayeeModal');
                modal.classList.remove('show');
                
                // Reset button states
                const submitBtn = document.getElementById('addPayeeSubmit');
                const transferBtn = document.getElementById('transferNowBtn');
                
                // Show Add Payee button, hide Transfer Now button
                submitBtn.style.display = 'inline-block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Payee';
                transferBtn.style.display = 'none';
                transferBtn.textContent = 'Proceed to Pay';
                
                // Reset form
                document.getElementById('addPayeeForm').reset();
                document.getElementById('ifscValidationMessage').textContent = '';
                document.getElementById('bankDetails').style.display = 'none';
                
                // Clear newly added payee reference
                this.newlyAddedPayee = null;
            }

            showSuccessMessage(message) {
                // Create and show a temporary success message
                const successDiv = document.createElement('div');
                successDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10b981;
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    font-weight: 600;
                `;
                successDiv.textContent = message;
                document.body.appendChild(successDiv);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    document.body.removeChild(successDiv);
                }, 3000);
            }

            selectAccount(accountType) {
                document.querySelectorAll('.account-option').forEach(el => el.classList.remove('selected'));
                document.getElementById(`${accountType}Account`).classList.add('selected');
                
                // Find the full account object instead of just storing the type
                const account = this.userAccounts.find(acc => acc.account_type === accountType);
                this.selectedAccount = account;
                this.selectedAccountType = accountType; // Keep the type for display purposes
                
                console.log('Selected account:', this.selectedAccount);
                console.log('Account properties:', {
                    accountNumber: this.selectedAccount?.accountNumber,
                    accountType: this.selectedAccount?.account_type,
                    balance: this.selectedAccount?.balance
                });
                this.validateStep2();
            }

            selectPaymentMode(mode) {
                document.querySelectorAll('.payment-mode').forEach(el => el.classList.remove('selected'));
                document.getElementById(`${mode.toLowerCase()}Mode`).classList.add('selected');
                this.selectedPaymentMode = mode;
                this.validateStep2();
            }

            validateStep2() {
                const amount = parseFloat(this.transferAmountInput.value);
                const isValid = this.selectedAccount && this.selectedPaymentMode && amount > 0;
                
                console.log('Validating step 2:', {
                    selectedAccount: this.selectedAccount,
                    selectedPaymentMode: this.selectedPaymentMode,
                    amount: amount,
                    isValid: isValid
                });
                
                this.continueToStep3.disabled = !isValid;

                // Validate amount against account balance
                if (amount > 0 && this.selectedAccount) {
                    console.log('Selected account for validation:', this.selectedAccount);
                    
                    if (this.selectedAccount && amount > parseFloat(this.selectedAccount.balance)) {
                        this.continueToStep3.disabled = true;
                        console.log('Amount exceeds balance. Transfer disabled.');
                    }
                }
            }

            goToStep(stepNumber) {
                if (stepNumber === 3) {
                    this.transferAmount = parseFloat(this.transferAmountInput.value);
                    this.transferNote = this.transferNoteInput.value;
                    this.updateConfirmationDetails();
                }

                // Hide current step
                document.querySelector('.transfer-step.active').classList.remove('active');
                
                // Show target step
                document.getElementById(`step${stepNumber}`).classList.add('active');
                
                // Update progress indicator
                this.updateProgressIndicator(stepNumber);
                
                this.currentStep = stepNumber;
            }

            updateProgressIndicator(activeStep) {
                for (let i = 1; i <= 5; i++) {
                    const circle = document.getElementById(`step${i}Circle`);
                    const connector = document.getElementById(`connector${i}`);

                    if (i < activeStep) {
                        circle.className = 'step-circle completed';
                        if (connector) connector.className = 'step-connector completed';
                    } else if (i === activeStep) {
                        circle.className = 'step-circle active';
                        if (connector) connector.className = 'step-connector';
                    } else {
                        circle.className = 'step-circle pending';
                        if (connector) connector.className = 'step-connector';
                    }
                }
            }

            updateConfirmationDetails() {
                this.confirmationDetails.innerHTML = `
                    <div class="detail-row">
                        <span class="detail-label">Transfer To:</span>
                        <span class="detail-value">${this.selectedPayee.name}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Account Number:</span>
                        <span class="detail-value">${this.selectedPayee.accountNumber}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Bank:</span>
                        <span class="detail-value">${this.selectedPayee.bankName}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Branch:</span>
                        <span class="detail-value">${this.selectedPayee.branchName}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">IFSC Code:</span>
                        <span class="detail-value">${this.selectedPayee.ifscCode}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Transfer From:</span>
                        <span class="detail-value">${this.selectedAccountType.charAt(0).toUpperCase() + this.selectedAccountType.slice(1)} Account</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Payment Mode:</span>
                        <span class="detail-value">${this.selectedPaymentMode}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Amount:</span>
                        <span class="detail-value" style="font-size: 18px; color: #059669;">₹${this.transferAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                    </div>
                    ${this.transferNote ? `
                    <div class="detail-row">
                        <span class="detail-label">Note:</span>
                        <span class="detail-value">${this.transferNote}</span>
                    </div>
                    ` : ''}
                `;
            }

            handlePinInput(e, index) {
                const value = e.target.value;
                
                if (value && index < 5) {
                    this.pinInputs[index + 1].focus();
                }

                this.validatePin();
            }

            handlePinKeydown(e, index) {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    this.pinInputs[index - 1].focus();
                }
            }

            validatePin() {
                const pin = this.pinInputs.map(input => input.value).join('');
                this.processTransferBtn.disabled = pin.length !== 6;
                this.pinError.style.display = 'none';
            }

            async processTransfer() {
                const pin = this.pinInputs.map(input => input.value).join('');
                
                try {
                    // Validate PIN (mock validation - in real app, validate with server)
                    if (pin !== '123456') {
                        this.pinError.style.display = 'block';
                        this.pinInputs.forEach(input => input.value = '');
                        this.pinInputs[0].focus();
                        return;
                    }

                    // Show loading
                    this.loadingOverlay.classList.add('show');

                    // Create PACS XML and initiate real transfer
                    const transferResult = await this.initiateRealTransfer();
                    
                    if (transferResult.success) {
                        // Store transaction reference
                        this.transactionId = transferResult.txnRef;
                        this.transactionIdSpan.textContent = this.transactionId;
                        
                        // Start polling for status updates
                        await this.pollTransactionStatus(transferResult.txnRef);
                        
                        // Update final transaction details
                        this.updateFinalTransactionDetails();
                        
                        // Hide loading and go to success step
                        this.loadingOverlay.classList.remove('show');
                        this.goToStep(5);
                    } else {
                        throw new Error(transferResult.message || 'Transfer initiation failed');
                    }
                    
                } catch (error) {
                    this.loadingOverlay.classList.remove('show');
                    alert('Transfer failed: ' + error.message);
                }
            }

            async initiateRealTransfer() {
                try {
                    // Create PACS XML payload
                    const pacsXml = this.createPacsXml();
                    
                    // Get authentication token
                    const token = localStorage.getItem('vubank_token');
                    if (!token) {
                        throw new Error('Authentication token not found');
                    }

                    // Generate request ID for tracing
                    const xRequestId = this.generateUUID();
                    
                    // Prepare request headers
                    const headers = {
                        'Content-Type': 'application/xml',
                        'X-Api-Client': 'web-portal',
                        'X-Request-Id': xRequestId,
                        'X-Signature': 'demo-signature-' + Date.now(), // Placeholder signature
                        'Authorization': 'Bearer ' + token
                    };
                    
                    // DETAILED FRONTEND REQUEST LOGGING
                    console.log('=== FRONTEND API REQUEST DEBUG ===');
                    console.log('URL:', 'http://localhost:8086/api/payments/transfer');
                    console.log('Method:', 'POST');
                    console.log('Headers:', headers);
                    console.log('Token present:', !!token);
                    console.log('Token length:', token ? token.length : 0);
                    console.log('XML Payload length:', pacsXml.length);
                    console.log('XML Preview:', pacsXml.substring(0, 200) + '...');
                    console.log('Request ID:', xRequestId);
                    console.log('Timestamp:', new Date().toISOString());
                    console.log('=== END FRONTEND REQUEST DEBUG ===');
                    
                    // Call payment-process-java-service
                    const response = await fetch('http://localhost:8086/api/payments/transfer', {
                        method: 'POST',
                        headers: headers,
                        body: pacsXml
                    });

                    // DETAILED FRONTEND RESPONSE LOGGING
                    console.log('=== FRONTEND API RESPONSE DEBUG ===');
                    console.log('Response Status:', response.status);
                    console.log('Response OK:', response.ok);
                    console.log('Response Status Text:', response.statusText);
                    console.log('Response Headers:');
                    for (let [key, value] of response.headers.entries()) {
                        console.log(`  ${key}: ${value}`);
                    }
                    console.log('Response Type:', response.type);
                    console.log('Response URL:', response.url);
                    console.log('=== END FRONTEND RESPONSE DEBUG ===');
                    
                    const responseText = await response.text();
                    console.log('=== RESPONSE BODY DEBUG ===');
                    console.log('Raw Response Body:', responseText);
                    console.log('Response Body Length:', responseText.length);
                    
                    let responseData;
                    try {
                        responseData = JSON.parse(responseText);
                        console.log('Parsed JSON Response:', responseData);
                    } catch (parseError) {
                        console.error('Failed to parse JSON response:', parseError);
                        console.log('Non-JSON response body:', responseText);
                        throw new Error('Invalid JSON response from server');
                    }
                    console.log('=== END RESPONSE BODY DEBUG ===');

                    if (response.status === 202) {
                        return {
                            success: true,
                            txnRef: responseData.txnRef,
                            status: responseData.status
                        };
                    } else if (response.status === 402) {
                        return {
                            success: false,
                            message: 'Insufficient balance in your account'
                        };
                    } else {
                        return {
                            success: false,
                            message: responseData.reason || 'Transfer initiation failed'
                        };
                    }
                } catch (error) {
                    console.error('=== FRONTEND ERROR DEBUG ===');
                    console.error('Error Type:', error.constructor.name);
                    console.error('Error Message:', error.message);
                    console.error('Error Stack:', error.stack);
                    console.error('Full Error Object:', error);
                    console.error('=== END FRONTEND ERROR DEBUG ===');
                    
                    return {
                        success: false,
                        message: error.message || 'Network error occurred'
                    };
                }
            }

            createPacsXml() {
                const now = new Date().toISOString();
                const userData = JSON.parse(localStorage.getItem('vubank_user') || '{}');
                
                console.log('Creating PACS XML with:', {
                    selectedAccount: this.selectedAccount,
                    selectedPayee: this.selectedPayee,
                    userData: userData
                });
                
                return `<?xml version="1.0" encoding="UTF-8"?>
<PaymentInstruction>
    <PayeeName>${this.selectedPayee.name}</PayeeName>
    <IFSCCode>${this.selectedPayee.ifscCode}</IFSCCode>
    <PaymentType>${this.selectedPaymentMode}</PaymentType>
    <DateTime>${now}</DateTime>
    <CustomerName>${userData.username || 'Unknown'}</CustomerName>
    <FromAccountNo>${this.selectedAccount.accountNumber}</FromAccountNo>
    <ToAccountNo>${this.selectedPayee.accountNumber}</ToAccountNo>
    <BranchName>${this.selectedPayee.bankName || 'Unknown Branch'}</BranchName>
    <Amount>${this.transferAmountInput.value}</Amount>
    <Comments>${this.transferNoteInput.value || ''}</Comments>
</PaymentInstruction>`;
            }

            async pollTransactionStatus(txnRef) {
                const maxPolls = 30; // Maximum 30 seconds of polling
                let pollCount = 0;
                
                // Show dynamic status
                this.showTransactionStatus('Initiated', 'Transaction has been initiated...', 'initiated');
                
                return new Promise((resolve) => {
                    const pollInterval = setInterval(async () => {
                        try {
                            pollCount++;
                            
                            // Random wait time around 1.3 seconds (1.0 to 1.6 seconds)
                            const randomWait = 1000 + Math.random() * 600;
                            await new Promise(resolve => setTimeout(resolve, randomWait));
                            
                            const response = await fetch(`http://localhost:8086/api/payments/status/${txnRef}`);
                            const statusData = await response.json();
                            
                            if (response.ok) {
                                const status = statusData.status;
                                
                                switch (status) {
                                    case 'IN_PROGRESS':
                                        this.showTransactionStatus('Processing', 'Payment is being processed by core banking...', 'processing');
                                        break;
                                    case 'SUCCESS':
                                        this.showTransactionStatus('Completed', 'Payment completed successfully!', 'success');
                                        clearInterval(pollInterval);
                                        resolve({ success: true, cbsId: statusData.cbsId });
                                        break;
                                    case 'FAILED':
                                        this.showTransactionStatus('Failed', `Payment failed: ${statusData.reason}`, 'failed');
                                        clearInterval(pollInterval);
                                        resolve({ success: false, reason: statusData.reason });
                                        break;
                                    default:
                                        this.showTransactionStatus('Processing', `Status: ${status}`, 'processing');
                                }
                            }
                            
                            // Stop polling after max attempts
                            if (pollCount >= maxPolls) {
                                clearInterval(pollInterval);
                                this.showTransactionStatus('Timeout', 'Status check timed out. Please check transaction history.', 'timeout');
                                resolve({ success: false, reason: 'Status polling timeout' });
                            }
                            
                        } catch (error) {
                            console.error('Status polling error:', error);
                            clearInterval(pollInterval);
                            this.showTransactionStatus('Error', 'Unable to check transaction status', 'error');
                            resolve({ success: false, reason: 'Status polling error' });
                        }
                    }, 100); // Quick interval, but actual delay is controlled by randomWait
                });
            }

            showTransactionStatus(status, message, statusType) {
                // Update the loading overlay to show status with refresh icon and dynamic colors
                const loadingContent = this.loadingOverlay.querySelector('.loading-content');
                if (loadingContent) {
                    const statusConfig = {
                        'initiated': { color: '#007bff', bgColor: '#e3f2fd' },
                        'processing': { color: '#ff9800', bgColor: '#fff3e0' },
                        'success': { color: '#4caf50', bgColor: '#e8f5e9' },
                        'failed': { color: '#f44336', bgColor: '#ffebee' },
                        'timeout': { color: '#9e9e9e', bgColor: '#f5f5f5' },
                        'error': { color: '#f44336', bgColor: '#ffebee' }
                    };
                    
                    const config = statusConfig[statusType] || statusConfig['processing'];
                    
                    // Create rotating refresh icon
                    const refreshIcon = statusType !== 'success' && statusType !== 'failed' && statusType !== 'error' && statusType !== 'timeout';
                    
                    loadingContent.innerHTML = `
                        <div class="status-container" style="
                            background: ${config.bgColor};
                            border: 2px solid ${config.color};
                            border-radius: 12px;
                            padding: 30px;
                            text-align: center;
                            max-width: 400px;
                            margin: 0 auto;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                        ">
                            <div class="refresh-icon" style="
                                font-size: 3em;
                                color: ${config.color};
                                margin-bottom: 20px;
                                ${refreshIcon ? 'animation: spin 1.5s linear infinite;' : ''}
                            ">
                                ${refreshIcon ? '🔄' : (statusType === 'success' ? '✅' : statusType === 'failed' ? '❌' : statusType === 'error' ? '⚠️' : '⏰')}
                            </div>
                            <div class="status-title" style="
                                font-size: 1.5em;
                                font-weight: bold;
                                color: ${config.color};
                                margin-bottom: 15px;
                                text-transform: uppercase;
                                letter-spacing: 1px;
                            ">${status}</div>
                            <div class="status-message" style="
                                font-size: 1.1em;
                                color: #333;
                                line-height: 1.4;
                                margin-bottom: 20px;
                            ">${message}</div>
                            <div class="status-indicator-bar" style="
                                width: 100%;
                                height: 4px;
                                background: #e0e0e0;
                                border-radius: 2px;
                                overflow: hidden;
                            ">
                                <div class="status-progress" style="
                                    height: 100%;
                                    background: ${config.color};
                                    width: ${statusType === 'success' ? '100%' : statusType === 'failed' || statusType === 'error' ? '100%' : '60%'};
                                    transition: width 0.3s ease;
                                    ${refreshIcon ? 'animation: progress 2s ease-in-out infinite;' : ''}
                                "></div>
                            </div>
                        </div>
                        
                        <style>
                        @keyframes spin {
                            from { transform: rotate(0deg); }
                            to { transform: rotate(360deg); }
                        }
                        @keyframes progress {
                            0%, 100% { width: 30%; }
                            50% { width: 80%; }
                        }
                        </style>
                    `;
                    
                    // Update page background color based on status
                    document.body.style.backgroundColor = config.bgColor;
                    document.body.style.transition = 'background-color 0.5s ease';
                }
            }

            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            async simulateTransferProcess() {
                // Legacy method - no longer used with real transfer system
                return Promise.resolve();
            }

            updateFinalTransactionDetails() {
                const now = new Date();
                
                this.finalTransactionDetails.innerHTML = `
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value">${now.toLocaleString('en-IN')}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Transfer To:</span>
                        <span class="detail-value">${this.selectedPayee.name}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Account Number:</span>
                        <span class="detail-value">${this.selectedPayee.accountNumber}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Amount Transferred:</span>
                        <span class="detail-value" style="font-size: 18px; color: #059669;">₹${this.transferAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Payment Mode:</span>
                        <span class="detail-value">${this.selectedPaymentMode}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" style="color: #10b981; font-weight: 600;">Successful</span>
                    </div>
                `;
            }

            async downloadReceipt() {
                try {
                    // Get the selected account details
                    const account = this.selectedAccount;
                    const accountNumber = account ? account.accountNumber : '****0000';
                    
                    // Prepare transaction data for PDF generation
                    const transactionData = {
                        transactionId: this.transactionId,
                        fromAccount: `${this.selectedAccountType} - ****${accountNumber.slice(-4)}`,
                        toAccount: this.selectedPayee.accountNumber,
                        payeeName: this.selectedPayee.name,
                        amount: this.transferAmount,
                        paymentMode: this.selectedPaymentMode.toUpperCase(),
                        timestamp: new Date().toISOString(),
                        status: 'SUCCESS',
                        customerName: 'John Doe', // This should come from user session
                        customerId: 'CUST001' // This should come from user session
                    };

                    // Call PDF generation service
                    const response = await fetch('http://localhost:8086/api/receipts/generate-receipt', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(transactionData)
                    });

                    if (response.ok) {
                        // Create blob and download the PDF
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `VuBank_Receipt_${this.transactionId}_${new Date().toISOString().slice(0, 10)}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        // Show success message
                        alert('Receipt downloaded successfully!');
                    } else {
                        throw new Error('Failed to generate receipt');
                    }
                } catch (error) {
                    console.error('Error downloading receipt:', error);
                    alert('Unable to download receipt. Please try again later.');
                }
            }

            makeAnotherTransfer() {
                // Reset form and go back to step 1
                this.resetForm();
                this.goToStep(1);
            }

            resetForm() {
                this.selectedPayee = null;
                this.selectedAccount = null;
                this.selectedPaymentMode = null;
                this.transferAmount = 0;
                this.transferNote = '';
                
                // Clear form inputs
                this.payeeSearch.value = '';
                this.transferAmountInput.value = '';
                this.transferNoteInput.value = '';
                
                // Clear selections
                document.querySelectorAll('.account-option').forEach(el => el.classList.remove('selected'));
                document.querySelectorAll('.payment-mode').forEach(el => el.classList.remove('selected'));
                
                // Clear PIN
                this.pinInputs.forEach(input => input.value = '');
                
                // Reset buttons
                this.continueToStep2.disabled = true;
                this.continueToStep3.disabled = true;
                this.processTransferBtn.disabled = true;
            }

            goToDashboard() {
                window.location.href = 'dashboard.html';
            }
        }

        // Global functions for onclick handlers
        function goBack() {
            window.location.href = 'dashboard.html';
        }

        function goToStep(stepNumber) {
            window.fundTransferManager.goToStep(stepNumber);
        }

        function selectAccount(accountType) {
            window.fundTransferManager.selectAccount(accountType);
        }

        function selectPaymentMode(mode) {
            window.fundTransferManager.selectPaymentMode(mode);
        }

        function showAddPayeeForm(query) {
            window.fundTransferManager.showAddPayeeForm(query);
        }

        function processTransfer() {
            window.fundTransferManager.processTransfer();
        }

        function downloadReceipt() {
            window.fundTransferManager.downloadReceipt();
        }

        function makeAnotherTransfer() {
            window.fundTransferManager.makeAnotherTransfer();
        }

        function goToDashboard() {
            window.fundTransferManager.goToDashboard();
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.fundTransferManager = new FundTransferManager();
        });
    </script>
</body>
</html>