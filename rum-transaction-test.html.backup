<!DOCTYPE html>
<html lang="en">
<head>
    <title>RUM Transaction Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .test-section { margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: white; padding: 10px; border: 1px solid #ddd; overflow: auto; }
        .log { font-family: monospace; background: #f8f9fa; padding: 10px; margin: 5px 0; border-left: 3px solid #007bff; }
    </style>
    
    <!-- Load Elastic APM RUM locally -->
    <script src="./elastic-apm-rum.js" 
            onload="console.log('‚úÖ Elastic APM RUM loaded successfully from local file')" 
            onerror="console.error('‚ùå Failed to load local Elastic APM RUM file')"></script>
</head>
<body>
    <h1>üîç RUM Transaction Debug Test</h1>
    
    <div class="test-section">
        <h3>0. Library Status Check</h3>
        <button onclick="checkLibraryStatus()">üîç Check if elasticApm is loaded</button>
        <div id="library-status" class="result info">Click button to check library status</div>
    </div>
    
    <div class="test-section">
        <h3>1. RUM Initialization Status</h3>
        <div id="rum-status" class="result info">Initializing...</div>
        <button onclick="checkRumStatus()">Check Status</button>
    </div>

    <div class="test-section">
        <h3>2. Create Login Transaction</h3>
        <button onclick="testLoginTransaction()">üöÄ Create Login Transaction</button>
        <div id="transaction-result" class="result info">Click button to create transaction</div>
        <pre id="transaction-details">No transaction created yet</pre>
    </div>

    <div class="test-section">
        <h3>3. Debug Log</h3>
        <button onclick="clearLogs()">Clear Logs</button>
        <div id="debug-log"></div>
    </div>

    <div class="test-section">
        <h3>4. Expected Service Map</h3>
        <div class="result info">
            <strong>For service map stitching, you need:</strong>
            <ul>
                <li>‚úÖ RUM transaction (user-login) active during fetch call</li>
                <li>‚úÖ Fetch call to distributedTracingOrigins (localhost:8000)</li>
                <li>‚úÖ RUM auto-instrumentation adds trace headers</li>
                <li>‚úÖ Backend continues the trace (same trace ID)</li>
                <li>‚úÖ Both transactions appear in APM with connection</li>
            </ul>
        </div>
    </div>

    <script>
        let apm;
        let currentTransaction = null;
        let logCounter = 0;

        function log(message) {
            logCounter++;
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="log">[${timestamp}] ${logCounter}: ${message}</div>`;
            console.log(`[RUM Test] ${message}`);
        }

        function clearLogs() {
            document.getElementById('debug-log').innerHTML = '';
            logCounter = 0;
        }

        function checkLibraryStatus() {
            const statusDiv = document.getElementById('library-status');
            
            if (typeof elasticApm === 'undefined') {
                log('‚ùå elasticApm is not defined - library failed to load');
                statusDiv.innerHTML = '‚ùå elasticApm library NOT loaded - check network connection or CDN availability';
                statusDiv.className = 'result error';
                
                // Try to manually load from jsdelivr
                log('üîÑ Attempting to load from backup CDN...');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@elastic/apm-rum@5.12.1/dist/bundles/elastic-apm-rum.umd.min.js';
                script.onload = () => {
                    log('‚úÖ Successfully loaded from backup CDN');
                    statusDiv.innerHTML = '‚úÖ elasticApm loaded from backup CDN';
                    statusDiv.className = 'result success';
                    initializeRUM();
                };
                script.onerror = () => {
                    log('‚ùå Backup CDN also failed');
                    statusDiv.innerHTML = '‚ùå Both CDNs failed - check internet connection';
                };
                document.head.appendChild(script);
                
            } else {
                log('‚úÖ elasticApm is available');
                statusDiv.innerHTML = `‚úÖ elasticApm library loaded successfully<br>Version: ${elasticApm.version || 'unknown'}`;
                statusDiv.className = 'result success';
                
                if (!apm) {
                    log('üîß Library loaded but not initialized, initializing now...');
                    initializeRUM();
                }
            }
        }

        // Wait for RUM library to load before initializing
        function initializeRUM() {
            if (typeof elasticApm === 'undefined') {
                log('‚ùå elasticApm is not defined - RUM library not loaded');
                document.getElementById('rum-status').innerHTML = '‚ùå RUM Library Not Loaded';
                document.getElementById('rum-status').className = 'result error';
                return false;
            }

            try {
                log('üîß Initializing RUM agent...');
        apm = elasticApm.init({
            serviceName: 'vubank-frontend',
            serverUrl: 'http://91.203.133.240:30200',
            environment: 'e2e-240-dev',
            
            // Enable distributed tracing
            distributedTracing: true,
            distributedTracingOrigins: [
                'http://localhost:8000',
                'http://localhost:8001', 
                'http://localhost:8002',
                'http://localhost:8003',
                'http://localhost:8004',
                'http://localhost:8005',
                'http://91.203.133.240:30200',
                'http://apm-server:30200',
                'https://91.203.133.240:30200',
                'https://apm-server:30200',
                window.location.origin
            ],
            
            // Enable all monitoring features
            active: true,
            logLevel: 'debug',
            
            // Capture everything
            capturePageLoad: true,
            capturePageLoadSpans: true,
            captureUserInteractions: true,
            captureErrors: true,
            
            // Sample rates
            transactionSampleRate: 1.0,
            spanSampleRate: 1.0,
            
            // Page load transaction
            pageLoadTransactionName: 'rum-transaction-test-page-load'
        });                log('‚úÖ RUM agent initialized successfully');
                document.getElementById('rum-status').innerHTML = '‚úÖ RUM Agent Active';
                document.getElementById('rum-status').className = 'result success';
                return true;

            } catch (error) {
                log(`‚ùå RUM initialization failed: ${error.message}`);
                document.getElementById('rum-status').innerHTML = `‚ùå Failed: ${error.message}`;
                document.getElementById('rum-status').className = 'result error';
                return false;
            }
        }

        function checkRumStatus() {
            if (typeof elasticApm === 'undefined') {
                log('‚ùå elasticApm is still not defined - library loading issue');
                document.getElementById('rum-status').innerHTML = '‚ùå elasticApm not available';
                document.getElementById('rum-status').className = 'result error';
                return;
            }

            if (!apm) {
                log('‚ö†Ô∏è APM instance not initialized, trying to initialize...');
                if (!initializeRUM()) {
                    return;
                }
            }

            try {
                const config = apm.getConfig();
                const isActive = apm.isActive();
                
                log(`üìä RUM Status: Active=${isActive}, Service=${config.serviceName}`);
                log(`üìä Distributed Tracing Origins: ${config.distributedTracingOrigins?.join(', ')}`);
                
                const statusDiv = document.getElementById('rum-status');
                statusDiv.innerHTML = `
                    <strong>RUM Configuration:</strong><br>
                    Active: ${isActive ? '‚úÖ' : '‚ùå'}<br>
                    Service: ${config.serviceName}<br>
                    Server: ${config.serverUrl}<br>
                    Tracing Origins: ${config.distributedTracingOrigins?.length || 0} configured
                `;
                statusDiv.className = 'result success';
            } catch (error) {
                log(`‚ùå Error checking status: ${error.message}`);
            }
        }

        async function testLoginTransaction() {
            if (typeof elasticApm === 'undefined') {
                log('‚ùå elasticApm not available');
                document.getElementById('transaction-result').innerHTML = '‚ùå RUM library not loaded';
                document.getElementById('transaction-result').className = 'result error';
                return;
            }

            if (!apm) {
                log('‚ö†Ô∏è APM not initialized, trying to initialize...');
                if (!initializeRUM()) {
                    document.getElementById('transaction-result').innerHTML = '‚ùå Failed to initialize RUM';
                    document.getElementById('transaction-result').className = 'result error';
                    return;
                }
            }

            try {
                log('üöÄ Starting explicit login transaction test...');

                // Create a explicit transaction for login
                currentTransaction = apm.startTransaction('user-login-test', 'user-interaction');
                
                if (!currentTransaction) {
                    log('‚ùå Failed to create transaction');
                    return;
                }

                log(`‚úÖ Transaction created - ID: ${currentTransaction.id}, TraceID: ${currentTransaction.traceId}`);

                // Add labels to help identify in APM
                currentTransaction.addLabels({
                    test_type: 'rum_debug',
                    timestamp: new Date().toISOString(),
                    page: 'rum-transaction-test',
                    action: 'debug_login'
                });

                log('üìù Added labels to transaction');

                // Update UI
                document.getElementById('transaction-result').innerHTML = '‚úÖ Transaction created successfully!';
                document.getElementById('transaction-result').className = 'result success';
                
                document.getElementById('transaction-details').textContent = JSON.stringify({
                    name: currentTransaction.name,
                    type: currentTransaction.type,
                    id: currentTransaction.id,
                    traceId: currentTransaction.traceId,
                    sampled: currentTransaction.sampled
                }, null, 2);

                // Now make a fetch call that should be instrumented
                log('üåê Making fetch call to login service...');

                const response = await fetch('http://localhost:8000/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Client': 'web-portal',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        username: 'sidharth',
                        password: 'password123',
                        force_login: true
                    })
                });

                const data = await response.json();
                log(`üì° API Response: ${response.status} - ${data.token ? 'Token received' : 'No token'}`);

                // Add response info to transaction
                currentTransaction.addLabels({
                    api_response_status: response.status,
                    api_success: response.ok,
                    token_received: !!data.token
                });

                // Keep transaction alive for a bit longer
                log('‚è±Ô∏è  Keeping transaction alive for 2 seconds...');
                await new Promise(resolve => setTimeout(resolve, 2000));

                // End the transaction
                log('üèÅ Ending transaction...');
                currentTransaction.end('completed');
                currentTransaction = null;

                log('üéØ Transaction ended - check APM dashboard for distributed trace!');
                
                document.getElementById('transaction-result').innerHTML += '<br><strong>üéØ Transaction completed - check APM dashboard!</strong>';

            } catch (error) {
                log(`‚ùå Transaction test failed: ${error.message}`);
                if (currentTransaction) {
                    currentTransaction.captureError(error);
                    currentTransaction.end('error');
                    currentTransaction = null;
                }
                
                document.getElementById('transaction-result').innerHTML = `‚ùå Test failed: ${error.message}`;
                document.getElementById('transaction-result').className = 'result error';
            }
        }

        // Auto-start page load transaction
        window.addEventListener('load', () => {
            log('üìÑ Page loaded - checking if RUM library is available...');
            
            // Wait a bit for script to load if needed
            setTimeout(() => {
                if (typeof elasticApm !== 'undefined') {
                    log('‚úÖ elasticApm is available, initializing...');
                    initializeRUM();
                } else {
                    log('‚ùå elasticApm still not available after page load');
                    // Try to wait a bit more
                    setTimeout(() => {
                        if (typeof elasticApm !== 'undefined') {
                            log('‚úÖ elasticApm loaded after delay, initializing...');
                            initializeRUM();
                        } else {
                            log('‚ùå elasticApm failed to load - check network connection');
                        }
                    }, 2000);
                }
            }, 1000);
        });

        // Also try to initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            log('üèóÔ∏è DOM ready - will initialize RUM when scripts load');
        });
    </script>
</body>
</html>